#!/bin/sh

set -e

echo % create p4 depot

DEBUG=0

if [ -n $P4ROOT ] ; then
    echo P4ROOT=$P4ROOT
else
    P4ROOT=$PWD/depot; export P4ROOT
fi

P4AUDIT=$P4ROOT/audit; export P4AUDIT
P4JOURNAL=$P4ROOT/journal; export P4JOURNAL
P4LOG=$P4ROOT/log; export P4LOG
P4PORT=localhost:16661; export P4PORT
P4DEBUG=$DEBUG; export P4DEBUG

if [ $DEBUG -ne 0 ] ; then
    HGDEBUG=--debug
    filter() { 
        cat
    }
else
    filter() { 
        sed -r -e 's,[0-9]{4}/[0-9]{2}/[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2},$DATE\ $TIME,' \
	       -e 's/[a-z]+@/$USER@/' \
	       -e 's/\{\{mercurial\ [0-9a-f]{40}(:[0-9a-f]{40})?\}\}/\{\{mercurial ids\}\}/'
    }
fi

rm -fr $P4ROOT $PWD/src $PWD/dst $PWD/new || true

echo % start the p4 server
[ ! -d $P4ROOT ] && mkdir $P4ROOT
p4d -f -J off >$P4ROOT/stdout 2>$P4ROOT/stderr &
trap "echo % stop the p4 server ; p4 admin stop" EXIT

# wait for the server to initialize
while ! p4 ; do
   sleep 1
done >/dev/null 2>/dev/null

echo % create a client spec
mkdir src
cd src

P4CLIENT=hg-p4-import; export P4CLIENT
DEPOTPATH=//depot/test-mercurial-push/...
p4 client -o | sed '/^View:/,$ d' >p4client-$$
echo View: >>p4client-$$
echo " $DEPOTPATH //$P4CLIENT/..." >>p4client-$$
p4 client -i <p4client-$$
rm p4client-$$

echo % populate the depot
echo a > a
mkdir b
echo c > b/c
p4 add a b/c
p4 submit -d initial

echo % change some files
p4 edit a
echo aa >> a
p4 submit -d "p4 change a"

p4 edit b/c
echo cc >> b/c
p4 submit -d "p4 change b/c"

echo dd >>b/d
p4 add b/d
p4 submit -d "p4 add b/d"

p4 delete b/c
p4 submit -d "p4 delete b/c"

cd ..

echo % convert
hg $HGDEBUG convert -s p4 $DEPOTPATH dst

echo "[paths]" >>dst/.hg/hgrc
echo "default = p4://$P4PORT/$P4CLIENT" >>dst/.hg/hgrc

echo % now work in hg
cd dst
hg $HGDEBUG up

echo % nothing incoming
hg $HGDEBUG incoming

echo % nothing outgoing
hg $HGDEBUG outgoing

echo % change some files in hg
echo aab >> a
hg $HGDEBUG commit -m "hg change a"

echo ee >> b/e
hg $HGDEBUG add b/e
hg $HGDEBUG ci -m "hg add b/e"

echo ddd >>b/d
hg $HGDEBUG commit -m "hg change b/d"

echo % outgoing
hg $HGDEBUG outgoing | filter

echo % skip a changelist
p4 change -o | sed -r 's/<.+>/test/' >change.$$
p4 change -d $(p4 change -i <change.$$ | awk '/created/ { print $2 }')

echo % push
# hg $HGDEBUG push --submit 
hg $HGDEBUG push
hg $HGDEBUG p4submit 7	

head .hg/p4stat

echo % outgoing
hg $HGDEBUG outgoing | filter

echo % p4 results
cd ../src
p4 changes	 | filter
p4 describe -s 7 | filter

cd ../dst

#echo % run bash
#bash

echo % incoming
hg $HGDEBUG incoming

echo % pull
hg $HGDEBUG pull

hg glog

