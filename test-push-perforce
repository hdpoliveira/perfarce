#!/bin/sh

set -e

echo % clean up
rm -fr $PWD/depot $PWD/src $PWD/dst || true

echo % create p4 depot
P4ROOT=$PWD/depot; export P4ROOT
P4AUDIT=$P4ROOT/audit; export P4AUDIT
P4JOURNAL=$P4ROOT/journal; export P4JOURNAL
P4LOG=$P4ROOT/log; export P4LOG
P4PORT=localhost:16661; export P4PORT
P4DEBUG=1; export P4DEBUG

echo % start the p4 server
[ ! -d $P4ROOT ] && mkdir $P4ROOT
p4d -f -J off >$P4ROOT/stdout 2>$P4ROOT/stderr &
trap "echo % stop the p4 server ; p4 admin stop" EXIT

# wait for the server to initialize
while ! p4 ; do
   sleep 1
done >/dev/null 2>/dev/null

echo % create a client spec
mkdir src
cd src

P4CLIENT=hg-p4-import; export P4CLIENT
DEPOTPATH=//depot/test-mercurial-push/...
p4 client -o | sed '/^View:/,$ d' >p4client-$$
echo View: >>p4client-$$
echo " $DEPOTPATH //$P4CLIENT/..." >>p4client-$$
p4 client -i <p4client-$$
rm p4client-$$

echo % populate the depot
echo a > a
mkdir b
echo c > b/c
p4 add a b/c
p4 submit -d initial

echo % change some files
p4 edit a
echo aa >> a
p4 submit -d "p4 change a"

p4 edit b/c
echo cc >> b/c
p4 submit -d "p4 change b/c"

echo dd >>b/d
p4 add b/d
p4 submit -d "p4 add b/d"

p4 delete b/c
p4 submit -d "p4 delete b/c"

cd ..

echo % convert
hg convert -s p4 $DEPOTPATH dst

echo % now work in hg
cd dst
hg up

echo % outgoing
hg out p4://$P4PORT/$P4CLIENT

echo % change some files in hg
echo aab >> a
hg commit -m "hg change a"

echo ee >> b/e
hg add b/e
hg ci -m "hg add b/e"

echo ddd >>b/d
hg commit -m "hg change b/d"

#echo % run bash
#bash

echo % outgoing
hg out p4://$P4PORT/$P4CLIENT

echo % push
hg --debug push --force p4://$P4PORT/$P4CLIENT

cd ../src
p4 changes
p4 describe -s 6
